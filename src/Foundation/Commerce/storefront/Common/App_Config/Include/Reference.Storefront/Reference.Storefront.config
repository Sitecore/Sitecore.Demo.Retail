<!--
// Copyright 2016 Sitecore Corporation A/S
// Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file
// except in compliance with the License. You may obtain a copy of the License at
//       http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software distributed under the
// License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
// either express or implied. See the License for the specific language governing permissions
// and limitations under the License.
-->

<configuration xmlns:patch="http://www.sitecore.net/xmlconfig/">
    <sitecore>
        <excludeUrlTracking>
            <url>/api/storefront/checkout/GetCheckoutData</url>
            <url>/api/storefront/checkout/GetShippingMethods</url>
            <url>/api/storefront/checkout/SetShippingMethods</url>
            <url>/api/storefront/checkout/SetPaymentMethods</url>
        </excludeUrlTracking>

        <sites>
            <site name="storefront" patch:before="site[@name='website']"
                  virtualFolder="/"
                  physicalFolder="/"
                  rootPath="/sitecore/content/storefront"
                  startItem="/home"
                  database="web"
                  domain="extranet"
                  allowDebug="true"
                  cacheHtml="true"
                  htmlCacheSize="10MB"
                  enablePreview="true"
                  enableWebEdit="true"
                  enableDebugger="true"
                  disableClientData="false"
                  requireLogin="false"
                  hostName="cf.reference.storefront.com"
                  contentLanguage="en"
                  content="master"
                  language="en"
                  enableTracking="true"
                  enableItemLanguageFallback="false"
                  enableFieldLanguageFallback="false" />
            <site name="shell">
                <patch:attribute name="enableItemLanguageFallback">false</patch:attribute>
            </site>
        </sites>

        <!--THERE IS A BUG RIGHT NOW THAT REPLACES '-' WITH ' ' THIS IS A TEMP FIX-->
        <encodeNameReplacements>
            <replace mode="on" find=" " replaceWith="-">
                <patch:delete />
            </replace>
        </encodeNameReplacements>
        <!--THERE IS A BUG RIGHT NOW THAT REPLACES '-' WITH ' ' THIS IS A TEMP FIX-->

        <events>
            <event name="publish:end">
                <handler type="Sitecore.Publishing.HtmlCacheClearer, Sitecore.Kernel">
                    <sites hint="list">
                        <site hint="storefront">storefront</site>
                    </sites>
                </handler>
            </event>
            <event name="publish:end:remote">
                <handler type="Sitecore.Publishing.HtmlCacheClearer, Sitecore.Kernel">
                    <sites hint="list">
                        <site hint="storefront">storefront</site>
                    </sites>
                </handler>
            </event>
        </events>

        <commerceServer>
            <types>
                <type name="CommerceStorefront" type="Sitecore.Reference.Storefront.Models.SitecoreItemModels.CommerceServerStorefront, Sitecore.Reference.Storefront" lifetime="PerCall" />
                <type name="OrderHeaderItemBaseJsonResult" type="Sitecore.Reference.Storefront.Models.JsonResults.OrderHeaderItemBaseJsonResult, Sitecore.Reference.Storefront" lifetime="PerCall" />
                <type name="CartLineBaseJsonResult" type="Sitecore.Reference.Storefront.Models.JsonResults.CartLineBaseJsonResult, Sitecore.Reference.Storefront" lifetime="PerCall" />
                <type name="ShippingMethodBaseJsonResult" type="Sitecore.Reference.Storefront.Models.JsonResults.ShippingMethodBaseJsonResult, Sitecore.Reference.Storefront" lifetime="PerCall" />
                <type name="ShippingOptionBaseJsonResult" type="Sitecore.Reference.Storefront.Models.JsonResults.ShippingOptionBaseJsonResult, Sitecore.Reference.Storefront" lifetime="PerCall" />
                <type name="LineShippingOptionBaseJsonResult" type="Sitecore.Reference.Storefront.Models.JsonResults.LineShippingOptionBaseJsonResult, Sitecore.Reference.Storefront" lifetime="PerCall" />
                <type name="ShippingMethodPerItemBaseJsonResult" type="Sitecore.Reference.Storefront.Models.JsonResults.ShippingMethodPerItemBaseJsonResult, Sitecore.Reference.Storefront" lifetime="PerCall" />
            </types>
        </commerceServer>

        <settings>
            <!-- Enforce white backgroundcolor for media handled by Sitecore -->
            <setting name="Media.DefaultImageBackgroundColor">
                <patch:attribute name="value">White</patch:attribute>
            </setting>

            <setting name="IgnoreUrlPrefixes">
                <patch:attribute name="value">/sitecore/default.aspx|/trace.axd|/webresource.axd|/sitecore/shell/Controls/Rich Text Editor/Telerik.Web.UI.DialogHandler.aspx|/sitecore/shell/applications/content manager/telerik.web.ui.dialoghandler.aspx|/sitecore/shell/Controls/Rich Text Editor/Telerik.Web.UI.SpellCheckHandler.axd|/Telerik.Web.UI.WebResource.axd|/sitecore/admin/upgrade/|/layouts/testing|/js|/styles|/bundles</patch:attribute>
            </setting>
            <setting name="Preview.ResolveSite">
                <patch:attribute name="value">true</patch:attribute>
            </setting>
            <setting name="Storefront.EnforceHTTPS" value="true" />
            <setting name="Storefront.UrlTokenDelimiter" value="_" />
            <setting name="Storefront.EncodedDelimiter" value="[[_]]" />
            <setting name="Storefront.ReadOnlySessionStateBehaviorEnabled" value="false" />
        </settings>

        <pipelines>
            <initialize>
                <processor patch:before="processor[@type='Sitecore.Mvc.Pipelines.Loader.InitializeGlobalFilters, Sitecore.Mvc']" type="Sitecore.Reference.Storefront.Infrastructure.SitecorePipelines.InitializeBundles, Sitecore.Reference.Storefront" />
                <processor patch:before="processor[@type='Sitecore.Mvc.Pipelines.Loader.InitializeGlobalFilters, Sitecore.Mvc']" type="Sitecore.Reference.Storefront.Infrastructure.SitecorePipelines.InitializeRoutes, Sitecore.Reference.Storefront" />
                <processor type="Sitecore.Mvc.Pipelines.Loader.InitializeControllerFactory, Sitecore.Mvc">
                    <patch:attribute name="type">Sitecore.Reference.Storefront.Infrastructure.SitecorePipelines.InitializeControllerFactory, Sitecore.Reference.Storefront</patch:attribute>
                </processor>
            </initialize>
        </pipelines>

        <commerce.Entities>
            <CartLine type="Sitecore.Commerce.Connect.CommerceServer.Orders.Models.CommerceCartLine, Sitecore.Commerce.Connect.CommerceServer">                
                <patch:attribute name="type">Sitecore.Reference.Storefront.Models.CommerceCartLineWithImages, Sitecore.Reference.Storefront</patch:attribute>
            </CartLine>
        </commerce.Entities>
    </sitecore>
</configuration>